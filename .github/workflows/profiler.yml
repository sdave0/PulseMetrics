name: Pipeline Profiler
on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed

permissions:
  actions: read
  contents: write

jobs:
  profile:
    runs-on: ubuntu-latest
    steps:
      - name: Download, Analyze, and Summarize
        id: analyze_step
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            // 1. Get Artifact List (ONCE)
            const allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });
            console.log(`Found ${allArtifacts.data.artifacts.length} artifacts`);

            // 2. Download all artifacts
            for (const artifact of allArtifacts.data.artifacts) {
              console.log(`Downloading artifact: ${artifact.name}`);
              try {
                const download = await github.rest.actions.downloadArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                  archive_format: 'zip',
                });
                fs.writeFileSync(`${artifact.name}.zip`, Buffer.from(download.data));
                console.log(`Downloaded: ${artifact.name}.zip`);
              } catch (error) {
                console.log(`Failed to download ${artifact.name}: ${error.message}`);
              }
            }

            // 3. Extract all artifacts
            execSync('mkdir -p dist');
            if (fs.existsSync('build-artifacts.zip')) {
              execSync('unzip -o build-artifacts.zip -d dist/');
              console.log('Extracted build artifacts');
            }
            if (fs.existsSync('test-results.zip')) {
              execSync('unzip -o test-results.zip');
              console.log('Extracted test results');
            }
            if (fs.existsSync('build-log.zip')) {
              execSync('unzip -o build-log.zip');
              console.log('Extracted build log');
            }

            // 4. Analyze and Build Summary
            const response = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });
            
            let summary = `## Pipeline Profile for Workflow Run #${response.data.run_number}\n\n`;
            summary += `**Status:** ${response.data.conclusion}\n`;
            summary += `**Trigger:** ${response.data.event}\n`;
            summary += `**Branch:** ${response.data.head_branch}\n`;
            
            const startTime = new Date(response.data.created_at).getTime();
            const endTime = new Date(response.data.updated_at).getTime();
            const totalDuration = Math.round((endTime - startTime) / 1000);
            summary += `**Total Duration:** ${totalDuration}s\n\n`;
            
            summary += '### Job Performance\n';
            summary += '| Job | Duration | Status |\n';
            summary += '| --- | --- | --- |\n';
            for (const job of jobs.data.jobs) {
              if (job.started_at && job.completed_at) {
                const jobStart = new Date(job.started_at).getTime();
                const jobEnd = new Date(job.completed_at).getTime();
                const duration = Math.round((jobEnd - jobStart) / 1000);
                summary += `| ${job.name} | ${duration}s | ${job.conclusion} |\n`;
              } else {
                summary += `| ${job.name} | N/A | ${job.conclusion} |\n`;
              }
            }
            
            summary += '\n### Test Summary\n';
            try {
              const testResults = JSON.parse(fs.readFileSync('test-results.json', 'utf8'));
              summary += `**Tests Passed:** ${testResults.numPassedTests || 0}\n`;
              summary += `**Tests Failed:** ${testResults.numFailedTests || 0}\n`;
              summary += `**Total Tests:** ${testResults.numTotalTests || 0}\n`;
              summary += `**Test Suites:** ${testResults.numTotalTestSuites || 0}\n`;
            } catch (error) {
              summary += 'Test results not available or could not be parsed.\n';
              console.log(`Test results error: ${error.message}`);
            }
            
            summary += '\n### Build Analysis\n';
            try {
              const buildLog = fs.readFileSync('build-log.txt', 'utf8');
              if (buildLog.includes('cache hit') || buildLog.includes('Cache hit')) {
                summary += '**Cache Status:** Hit ✅\n';
              } else if (buildLog.includes('cache miss') || buildLog.includes('Cache miss')) {
                summary += '**Cache Status:** Miss ❌\n';
              } else {
                summary += '**Cache Status:** Unknown\n';
              }
              try {
                const buildSize = execSync('du -sh dist/ 2>/dev/null || echo "0B unknown"').toString().trim();
                summary += `**Build Size:** ${buildSize.split('\t')[0]}\n`;
              } catch (e) {
                summary += '**Build Size:** Unknown\n';
              }
            } catch (error) {
              summary += 'Build log not available.\n';
              console.log(`Build log error: ${error.message}`);
            }
            
            summary += '\n### Artifacts\n';
            if (allArtifacts.data.artifacts.length > 0) {
              summary += '| Name | Size | Status |\n';
              summary += '| --- | --- | --- |\n';
              for (const artifact of allArtifacts.data.artifacts) {
                const sizeKB = Math.round(artifact.size_in_bytes / 1024);
                summary += `| ${artifact.name} | ${sizeKB} KB | ${artifact.expired ? 'Expired' : 'Available'} |\n`;
              }
            } else {
              summary += 'No artifacts found.\n';
            }
            
            await core.summary.addRaw(summary).write();
            console.log('Pipeline profile summary created successfully!');
            core.setOutput("summary_data", summary);

      - name: Send Summary to Webhook
        if: success()
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          SUMMARY_DATA: ${{ steps.analyze_step.outputs.summary_data }}
        run: |
          PAYLOAD=$(jq -n --arg content "$SUMMARY_DATA" '{ "text": $content }')
          curl -X POST -H "Content-Type: application/json" -d "$PAYLOAD" "$WEBHOOK_URL"